use libblas::level3;
mod fixtures;
mod utils;

#[test]
fn gemm() {
    let a = fixtures::matrix_mxn(8, 8);
    let b = fixtures::matrix_mxn(8, 8);
    let mut c = fixtures::matrix_mxn(8, 8);
    level3::gemm('n', 'n', 6, 0, 4, 0.3, &a, 8, &b, 8, 0.2, &mut c, 8);
    approximately!(c, fixtures::matrix_mxn(8, 8));

    let mut c = fixtures::matrix_mxn(8, 8);
    level3::gemm('n', 'n', 0, 8, 4, 0.3, &a, 8, &b, 8, 0.2, &mut c, 8);
    approximately!(c, fixtures::matrix_mxn(8, 8));

    let mut c = fixtures::matrix_mxn(8, 8);
    level3::gemm('n', 'n', 6, 8, 4, 0.0, &a, 8, &b, 8, 1.0, &mut c, 8);
    approximately!(c, fixtures::matrix_mxn(8, 8));

    let mut c = fixtures::matrix_mxn(8, 8);
    level3::gemm('n', 'c', 6, 8, 4, 0.0, &a, 8, &b, 8, 0.0, &mut c, 8);
    approximately!(
        c,
        vec![
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            -0.9285670347135381,
            -0.2947204467905602,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            -0.29921511789731614,
            -0.411510832795067,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.1333363608148414,
            0.8041895097449078,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            -0.23570655643950122,
            -0.5428882550102544,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            1.2383041008533804,
            -0.2793462818542693,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            -1.563782051071005,
            1.1565369971501793,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            -0.054877473711578625,
            0.2501413228541527,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            -0.9406491626186084,
            -0.11582532215695436
        ]
    );
    let a = fixtures::matrix_mxn(6, 6);
    let b = fixtures::matrix_mxn(6, 6);
    let mut c = fixtures::matrix_mxn(6, 6);
    level3::gemm('n', 'c', 6, 6, 3, 0.0, &a, 6, &b, 6, 0.75, &mut c, 6);
    approximately!(
        c,
        vec![
            0.94721567630767822,
            -0.24467501789331436,
            0.99734947085380554,
            0.95432201027870178,
            0.31098107993602753,
            -1.1549625098705292,
            -0.69642528891563416,
            -0.22104033082723618,
            -4.3253795010969043E-003,
            1.8034899830818176,
            0.57269507646560669,
            -0.59925694763660431,
            -0.86074277758598328,
            -0.21709618717432022,
            -0.22441133111715317,
            -0.30863311886787415,
            0.18916759639978409,
            -0.66894082725048065,
            0.32676248252391815,
            -0.92815384268760681,
            -0.16820091381669044,
            0.28304674476385117,
            0.10000227391719818,
            0.60314212739467621,
            -4.2830080725252628E-002,
            0.37770599126815796,
            0.81432706117630005,
            -0.51821538805961609,
            -0.96344947814941406,
            3.5044628195464611E-002,
            -0.17677991464734077,
            -0.40716621279716492,
            -0.32498274743556976,
            -0.48710373044013977,
            0.54506304860115051,
            0.86393380165100098,
        ]
    );
    let mut c = fixtures::matrix_mxn(6, 6);
    level3::gemm('n', 'n', 4, 6, 3, 0.3, &a, 6, &b, 6, -1.2, &mut c, 6);
    approximately!(
        c,
        vec![
            -1.4039963092403844,
            0.18124124487022381,
            -1.2107208849353177,
            -1.4443207422595890,
            0.41464143991470337,
            -1.5399500131607056,
            0.84654511690969958,
            0.47110226605777850,
            -0.36249415168348781,
            -3.4519430694935669,
            0.76359343528747559,
            -0.79900926351547241,
            1.1260112382918237,
            0.51125157946674815,
            -7.1428211629562310E-002,
            -0.11615811188891931,
            0.25222346186637878,
            -0.89192110300064087,
            6.4210470875263270E-002,
            1.5712993271415543,
            0.46520531931755910,
            -1.1516306540304853,
            0.13333636522293091,
            0.80418950319290161,
            -0.46722627045877629,
            -0.73755420551909645,
            -1.4240404210621318,
            1.0366043860301484,
            -1.2845993041992188,
            4.6726170927286148E-002,
            0.49396185302075668,
            0.76016266322751813,
            0.46577487040588361,
            0.35124613688394185,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );
    let mut c = fixtures::matrix_mxn(6, 6);
    level3::gemm('n', 'n', 4, 6, 3, 0.3, &a, 6, &b, 6, 0.0, &mut c, 6);
    approximately!(
        c,
        vec![
            0.11154883307425167,
            -0.21023879931509784,
            0.38503833184054292,
            8.2594534860493257E-002,
            0.41464143991470337,
            -1.5399500131607056,
            -0.26773538963284260,
            0.11743772268083484,
            -0.36941475916024308,
            -0.56635898189985345,
            0.76359343528747559,
            -0.79900926351547241,
            -0.25117726057030149,
            0.16389766618523197,
            -0.43048635568469557,
            -0.60997112169988321,
            0.25222346186637878,
            -0.89192110300064087,
            0.58703046368853140,
            8.6253119830951214E-002,
            0.19608384651692823,
            -0.69875584441269589,
            0.13333636522293091,
            0.80418950319290161,
            -0.53575440234224370,
            -0.13322459547614354,
            -0.12111707140653165,
            0.20745973218751551,
            -1.2845993041992188,
            4.6726170927286148E-002,
            0.21111397834564721,
            0.10869669686512365,
            -5.4197546152874670E-002,
            -0.42811986278950293,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );
    let mut c = fixtures::matrix_mxn(6, 6);
    level3::gemm('n', 'n', 4, 6, 3, 0.3, &a, 6, &b, 6, 1.0, &mut c, 6);
    approximately!(
        c,
        vec![
            1.3745030681511559,
            -0.53647215650618363,
            1.7148376263122835,
            1.3550238818987623,
            0.41464143991470337,
            -1.5399500131607056,
            -1.1963024415203547,
            -0.17728271842214668,
            -0.37518193182837228,
            1.8382943288759033,
            0.76359343528747559,
            -0.79900926351547241,
            -1.3988342973516126,
            -0.12556391671386166,
            -0.72970146384089973,
            -1.0214819468570489,
            0.25222346186637878,
            -0.89192110300064087,
            1.0227137737204224,
            -1.1512853370858578,
            -2.8184038571992344E-002,
            -0.32136018472756100,
            0.13333636522293091,
            0.80418950319290161,
            -0.59286117664258053,
            0.37038339288140038,
            0.96465234349520179,
            -0.48349411855863927,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -2.4592574517473847E-002,
            -0.43419158686442960,
            -0.48750787606696766,
            -1.0775915033763559,
            0.72675073146820068,
            1.1519117355346680
        ]
    );
    let mut c = fixtures::matrix_mxn(6, 6);
    level3::gemm('c', 'n', 4, 6, 3, 0.3, &a, 6, &b, 6, 1.0, &mut c, 6);
    approximately!(
        c,
        vec![
            2.3039086064868313,
            -0.65151114030011925,
            0.80392857434356968,
            1.4691522943492057,
            0.41464143991470337,
            -1.5399500131607056,
            -1.2538448349965456,
            -9.9813792277925195E-003,
            0.34004655561627861,
            2.3930913417469486,
            0.76359343528747559,
            -0.79900926351547241,
            -1.6735277569094822,
            5.6352145385314190E-002,
            0.14791521851026912,
            -0.43391807697828583,
            0.25222346186637878,
            -0.89192110300064087,
            0.63240625734282752,
            -1.2491004259456175,
            -0.24667513691004092,
            0.90888091978565244,
            0.13333636522293091,
            0.80418950319290161,
            0.30512477050075026,
            0.47311061141257815,
            0.96423497396955082,
            -0.95843924086395926,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.44474478900959474,
            -0.42847770252990852,
            -0.26611774831495649,
            -0.44957283992730146,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );
    let mut c = fixtures::matrix_mxn(6, 6);
    level3::gemm('c', 'n', 4, 6, 3, 0.3, &a, 6, &b, 6, 0.0, &mut c, 6);
    approximately!(
        c,
        vec![
            1.0409543714099270,
            -0.32527778310903349,
            -0.52587072012817104,
            0.19672294731093659,
            0.41464143991470337,
            -1.5399500131607056,
            -0.32527778310903349,
            0.28473906187518905,
            0.34581372828440782,
            -1.1561969028808390E-002,
            0.76359343528747559,
            -0.79900926351547241,
            -0.52587072012817104,
            0.34581372828440782,
            0.44713032666647334,
            -2.2407251821120321E-002,
            0.25222346186637878,
            -0.89192110300064087,
            0.19672294731093659,
            -1.1561969028808390E-002,
            -2.2407251821120321E-002,
            0.53148526010051755,
            0.13333636522293091,
            0.80418950319290161,
            0.36223154480108710,
            -3.0497376944965775E-002,
            -0.12153444093218260,
            -0.26748539011780442,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.20903823614647371,
            0.11441058119964469,
            0.16719258159913650,
            0.19989880065955160,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );
    let mut c = fixtures::matrix_mxn(6, 6);
    level3::gemm('n', 'c', 4, 6, 3, 0.3, &a, 6, &b, 6, 0.0, &mut c, 6);
    approximately!(
        c,
        vec![
            1.1323220981414599,
            5.8155756369945882E-002,
            0.60846817867763747,
            -4.6076554446066703E-002,
            0.41464143991470337,
            -1.5399500131607056,
            5.8155756369945882E-002,
            8.3122908219772917E-002,
            -0.10365417583453679,
            -0.30140785416513954,
            0.76359343528747559,
            -0.79900926351547241,
            0.60846817867763747,
            -0.10365417583453679,
            0.55737875359035660,
            0.54040137742259420,
            0.25222346186637878,
            -0.89192110300064087,
            -4.6076554446066703E-002,
            -0.30140785416513954,
            0.54040137742259420,
            2.2712326344858456,
            0.13333636522293091,
            0.80418950319290161,
            -0.14245217765629503,
            -0.12999764483403706,
            0.14145512021468692,
            0.67799604713505268,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -5.3799957506489804E-002,
            0.29881330774903153,
            -0.53290206537630114,
            -1.0541348433374778,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::gemm('n', 'c', 4, 6, 3, 0.3, &a, 6, &b, 6, 1.0, &mut c, 6);
    approximately!(
        c,
        vec![
            2.3952763332183640,
            -0.26807760082113996,
            1.9382674731493781,
            1.2263527925922022,
            0.41464143991470337,
            -1.5399500131607056,
            -0.87041129551756624,
            -0.21159753288320862,
            -0.10942134850266599,
            2.1032454566106171,
            0.76359343528747559,
            -0.79900926351547241,
            -0.53918885810367356,
            -0.39311575873363042,
            0.25816364543415238,
            0.12889055226542873,
            0.25222346186637878,
            -0.89192110300064087,
            0.38960675558582425,
            -1.5389463110819486,
            0.31613349233367366,
            2.6486282941709804,
            0.13333636522293091,
            0.80418950319290161,
            -0.19955895195663187,
            0.37361034352350686,
            1.2272245351164204,
            -1.2957803611101958E-002,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.28950651036961084,
            -0.24407497598052169,
            -0.96621239529039427,
            -1.7036064839243306,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::gemm('n', 'c', 4, 6, 3, 0.3, &a, 6, &b, 6, 0.5, &mut c, 6);
    approximately!(
        c,
        vec![
            1.7637992156799120,
            -0.10496092222559705,
            1.2733678259135077,
            0.59013811907306790,
            0.41464143991470337,
            -1.5399500131607056,
            -0.40612776957381014,
            -6.4237312331717866E-002,
            -0.10653776216860139,
            0.90091880122273893,
            0.76359343528747559,
            -0.79900926351547241,
            3.4639660286981871E-002,
            -0.24838496728408360,
            0.40777119951225449,
            0.33464596484401149,
            0.25222346186637878,
            -0.89192110300064087,
            0.17176510056987879,
            -0.92017708262354403,
            0.42826743487813396,
            2.4599304643284130,
            0.13333636522293091,
            0.80418950319290161,
            -0.17100556480646345,
            0.12180634934473492,
            0.68433982766555357,
            0.33251912176197540,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.17165323393805032,
            2.7369165884254920E-002,
            -0.74955723033334765,
            -1.3788706636309043,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );
    let mut c = fixtures::matrix_mxn(6, 6);
    level3::gemm('c', 'c', 4, 6, 3, 0.3, &a, 6, &b, 6, 0.5, &mut c, 6);
    approximately!(
        c,
        vec![
            0.74302595061270371,
            -0.43085206822838551,
            0.41372238666556888,
            1.2232451372076660,
            0.41464143991470337,
            -1.5399500131607056,
            -0.67452232525885392,
            -2.9922497870655915E-002,
            0.16101407985116736,
            1.2885797752188297,
            0.76359343528747559,
            -0.79900926351547241,
            -0.18879018655011265,
            -0.51414555060978995,
            -0.58009390976279773,
            -9.6715660616545351E-003,
            0.25222346186637878,
            -0.89192110300064087,
            0.30043618987643866,
            -1.1851282103582581,
            -0.72210506424434351,
            -0.51005801457012856,
            0.13333636522293091,
            0.80418950319290161,
            0.15443764840970681,
            6.8346909955205232E-002,
            0.31117483789830569,
            -0.59174378784732873,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.97894300163598880,
            0.22972839886126217,
            0.46299282935915376,
            -0.16936478468399807,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );
    let mut c = fixtures::matrix_mxn(6, 6);
    level3::gemm('c', 'c', 4, 6, 3, 0.3, &a, 6, &b, 6, 0.0, &mut c, 6);
    approximately!(
        c,
        vec![
            0.11154883307425162,
            -0.26773538963284260,
            -0.25117726057030149,
            0.58703046368853140,
            0.41464143991470337,
            -1.5399500131607056,
            -0.21023879931509784,
            0.11743772268083487,
            0.16389766618523197,
            8.6253119830951214E-002,
            0.76359343528747559,
            -0.79900926351547241,
            0.38503833184054287,
            -0.36941475916024313,
            -0.43048635568469557,
            0.19608384651692823,
            0.25222346186637878,
            -0.89192110300064087,
            8.2594534860493229E-002,
            -0.56635898189985345,
            -0.60997112169988321,
            -0.69875584441269600,
            0.13333636522293091,
            0.80418950319290161,
            0.18299103555987523,
            -0.18345708422356674,
            -0.23170986955256098,
            -0.24626686247425131,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.86108972520442828,
            0.50117254072603878,
            0.67964799431620027,
            0.15537103560942844,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );
    let a = vec![];
    let b = vec![];
    let result = std::panic::catch_unwind(|| {
        level3::gemm('x', 't', 6, 8, 4, 0.0, &a, 8, &b, 8, 0.2, &mut vec![], 8);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::gemm('c', 'x', 6, 8, 4, 0.0, &a, 8, &b, 8, 0.2, &mut vec![], 8);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::gemm('n', 'n', 6, 8, 4, 0.0, &a, 4, &b, 8, 0.2, &mut vec![], 8);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::gemm('n', 'n', 6, 8, 4, 0.0, &a, 8, &b, 3, 0.2, &mut vec![], 8);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::gemm('n', 'n', 6, 8, 4, 0.0, &a, 8, &b, 8, 0.2, &mut vec![], 5);
    });
    assert!(result.is_err());
}

#[test]
fn symm() {
    let a = fixtures::matrix_mxn(6, 6);
    let b = fixtures::matrix_mxn(6, 6);
    let mut c = fixtures::matrix_mxn(6, 6);
    level3::symm('l', 'u', 6, 0, 0.3, &a, 6, &b, 6, 0.2, &mut c, 6);
    approximately!(c, a);

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::symm('l', 'u', 0, 0, 0.3, &a, 6, &b, 6, 0.2, &mut c, 6);
    approximately!(c, b);

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::symm('l', 'u', 6, 4, 0.0, &a, 6, &b, 6, 1.0, &mut c, 6);
    approximately!(c, a);

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::symm('l', 'u', 6, 4, 0.0, &a, 6, &b, 6, 0.0, &mut c, 6);
    approximately!(
        c,
        vec![
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            -0.057106774383808755,
            0.5036079722337261,
            1.085769362145687,
            -0.6909538396968303,
            -1.2845993538721883,
            0.04672617218835198,
            -0.23570655643950122,
            -0.5428882550102544,
            -0.4333103174567822,
            -0.6494716467962331,
            0.726750747385451,
            1.1519117540872
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::symm('l', 'u', 4, 6, 0.0, &a, 6, &b, 6, 0.2, &mut c, 6);
    approximately!(
        c,
        vec![
            0.25259085077927779,
            -6.5246672410468332E-002,
            0.26595986285745887,
            0.25448587319978877,
            0.41464143991470337,
            -1.5399500131607056,
            -0.18571341314484791,
            -5.8944089098931673E-002,
            -1.1534345508133551E-003,
            0.48093066932157669,
            0.76359343528747559,
            -0.79900926351547241,
            -0.22953141077654671,
            -5.7892317442481467E-002,
            -5.9843022522971356E-002,
            -8.2302166257830933E-002,
            0.25222346186637878,
            -0.89192110300064087,
            8.7136663304815620E-002,
            -0.24750769507151382,
            -4.4853577686154500E-002,
            7.5479133061753689E-002,
            0.13333636522293091,
            0.80418950319290161,
            -1.1421355030258817E-002,
            0.10072159917237755,
            0.21715388621619169,
            -0.13819077220843390,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -4.7141311275084474E-002,
            -0.10857765836384381,
            -8.6662067274184018E-002,
            -0.12989433005294693,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::symm('l', 'u', 4, 6, 0.3, &a, 6, &b, 6, 0.2, &mut c, 6);
    approximately!(
        c,
        vec![
            0.53045255937201419,
            -0.97610554196043720,
            -0.34552037224813309,
            0.59527162008373635,
            0.41464143991470337,
            -1.5399500131607056,
            -0.13914859611314478,
            -0.66646951257570863,
            0.18287433359087329,
            0.74162042787135773,
            0.76359343528747559,
            -0.79900926351547241,
            -0.53449519300966108,
            0.46616525548773913,
            0.41497390397842687,
            -0.15130013972862894,
            0.25222346186637878,
            -0.89192110300064087,
            0.72349462601443237,
            -0.38009509799137947,
            -9.2652148448032115E-002,
            0.64969264004489258,
            0.13333636522293091,
            0.80418950319290161,
            -0.63748687919285363,
            0.23434080328254564,
            0.14210707477152720,
            -0.48390506072907413,
            -1.2845993041992188,
            4.6726170927286148E-002,
            7.9083477454552742E-002,
            0.28383508900112775,
            0.12422720543919644,
            -3.5278657891264220E-003,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::symm('l', 'u', 4, 6, 0.3, &a, 6, &b, 6, 0.0, &mut c, 6);
    approximately!(
        c,
        vec![
            0.27786170859273651,
            -0.91085886954996897,
            -0.61148023510559191,
            0.34078574688394758,
            0.41464143991470337,
            -1.5399500131607056,
            4.6564817031703065E-002,
            -0.60752542347677707,
            0.18402776814168664,
            0.26068975854978099,
            0.76359343528747559,
            -0.79900926351547241,
            -0.30496378223311432,
            0.52405757293022059,
            0.47481692650139823,
            -6.8997973470798002E-002,
            0.25222346186637878,
            -0.89192110300064087,
            0.63635796270961664,
            -0.13258740291986568,
            -4.7798570761877608E-002,
            0.57421350698313889,
            0.13333636522293091,
            0.80418950319290161,
            -0.62606552416259487,
            0.13361920411016809,
            -7.5046811444664491E-002,
            -0.34571428852064023,
            -1.2845993041992188,
            4.6726170927286148E-002,
            0.12622478872963722,
            0.39241274736497156,
            0.21088927271338045,
            0.12636646426382053,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::symm('l', 'l', 4, 6, 0.3, &a, 6, &b, 6, 0.0, &mut c, 6);
    approximately!(
        c,
        vec![
            1.5266773236720930,
            0.82086366225358753,
            0.22795279043235117,
            0.22665733443350428,
            0.41464143991470337,
            -1.5399500131607056,
            0.59264768599118844,
            1.8516542207052114,
            -0.66627703139676198,
            -0.29410725432126406,
            0.76359343528747559,
            -0.79900926351547241,
            -0.68295626153636280,
            -0.15843030315537335,
            -0.37968400589953227,
            -0.65656184334956080,
            0.25222346186637878,
            -0.89192110300064087,
            0.34078574688394758,
            0.33941778303287473,
            0.14949312486725058,
            -0.65602759753007456,
            0.13333636522293091,
            0.80418950319290161,
            9.8474547178773880E-002,
            -0.53926793690564545,
            -3.5816571237173092E-002,
            0.12923083378467967,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.45696027866355104,
            -0.39670787800307949,
            2.5981840253389940E-002,
            -0.50165219918523396,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::symm('l', 'l', 4, 6, 0.3, &a, 6, &b, 6, 0.2, &mut c, 6);
    approximately!(
        c,
        vec![
            1.7792681744513708,
            0.75561698984311920,
            0.49391265328980999,
            0.48114320763329299,
            0.41464143991470337,
            -1.5399500131607056,
            0.40693427284634065,
            1.7927101316062797,
            -0.66743046594757538,
            0.18682341500031258,
            0.76359343528747559,
            -0.79900926351547241,
            -0.91248767231290950,
            -0.21632262059785481,
            -0.43952702842250363,
            -0.73886400960739174,
            0.25222346186637878,
            -0.89192110300064087,
            0.42792241018876320,
            9.1910087961360895E-002,
            0.10463954718109607,
            -0.58054846446832087,
            0.13333636522293091,
            0.80418950319290161,
            8.7053192148515063E-002,
            -0.43854633773326795,
            0.18133731497901859,
            -8.9599384237542233E-003,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.50410158993863552,
            -0.50528553636692330,
            -6.0680227020794071E-002,
            -0.63154652923818089,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::symm('r', 'u', 4, 6, 0.3, &a, 6, &b, 6, 0.0, &mut c, 6);
    approximately!(
        c,
        vec![
            1.2069137139176491,
            -7.3835834769104269E-002,
            0.59119403421791594,
            6.1013807027786041E-002,
            0.41464143991470337,
            -1.5399500131607056,
            -0.30205181103150330,
            0.76602837643595145,
            -2.6074634033833186E-002,
            -0.67006228282670588,
            0.76359343528747559,
            -0.79900926351547241,
            -0.26845140503002302,
            0.48177209420755546,
            -5.4015942047744431E-003,
            -0.77600058244796255,
            0.25222346186637878,
            -0.89192110300064087,
            0.69412082516238416,
            -5.2473178741576046E-002,
            3.0054385768848807E-002,
            -0.38625839607415458,
            0.13333636522293091,
            0.80418950319290161,
            -0.65544770148229170,
            -0.18914368764400286,
            -0.58753563253647978,
            0.25390929255033634,
            -1.2845993041992188,
            4.6726170927286148E-002,
            3.2320124684197968E-002,
            0.27201196956553220,
            7.6483687116582072E-002,
            -0.87673778042864170,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::symm('r', 'u', 4, 6, 0.3, &a, 6, &b, 6, 1.0, &mut c, 6);
    approximately!(
        c,
        vec![
            2.4698679489945534,
            -0.40006919196019014,
            1.9209933286896568,
            1.3334431540660550,
            0.41464143991470337,
            -1.5399500131607056,
            -1.2306188629190153,
            0.47130793533296989,
            -3.1841806701962391E-002,
            1.7345910279490508,
            0.76359343528747559,
            -0.79900926351547241,
            -1.4161084418113339,
            0.19231051130846183,
            -0.30461670236097865,
            -1.1875114076051281,
            0.25222346186637878,
            -0.89192110300064087,
            1.1298041351942749,
            -1.2900116356583851,
            -0.19421349932007176,
            -8.8627363890197708E-003,
            0.13333636522293091,
            0.80418950319290161,
            -0.71255447578262854,
            0.31446430071354103,
            0.49823378236525351,
            -0.43704455819581839,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.20338642817892308,
            -0.27087631416402108,
            -0.35682664279751086,
            -1.5262094210154946,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::symm('r', 'l', 4, 6, 0.3, &a, 6, &b, 6, 1.0, &mut c, 6);
    approximately!(
        c,
        vec![
            1.6426051899320373,
            -0.69542496968745016,
            1.9644724972155001,
            1.7131834185435835,
            0.41464143991470337,
            -1.5399500131607056,
            -0.61036864849532357,
            -0.88349107729995568,
            5.5918617771216025E-002,
            2.3378719962510668,
            0.76359343528747559,
            -0.79900926351547241,
            -0.53422698334080476,
            -5.6967023782224679E-002,
            0.48395079754499476,
            0.20380064238818776,
            0.25222346186637878,
            -0.89192110300064087,
            0.37978410864815848,
            -1.7898895539087565,
            0.22963484945810722,
            2.5070282684360445,
            0.13333636522293091,
            0.80418950319290161,
            -0.16342752448046038,
            0.12241720098935280,
            0.79374592826822621,
            0.25931383076553666,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.26664938365290924,
            -0.72318793972417317,
            -1.1548389885797132,
            -1.8466830909154144,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let a = vec![];
    let b = vec![];
    let result = std::panic::catch_unwind(|| {
        level3::symm('x', 'u', 6, 6, 0.3, &a, 6, &b, 6, 0.2, &mut vec![], 6);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::symm('l', 'x', 0, 8, 0.3, &a, 6, &b, 6, 0.2, &mut vec![], 6);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::symm('l', 'u', 6, 4, 0.3, &a, 5, &b, 6, 0.2, &mut vec![], 6);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::symm('l', 'u', 3, 4, 0.3, &a, 6, &b, 2, 0.2, &mut vec![], 6);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::symm('l', 'u', 3, 4, 0.3, &a, 6, &b, 6, 0.2, &mut vec![], 2);
    });
    assert!(result.is_err());
}

#[test]
fn syr2k() {
    let a = fixtures::matrix_mxn(6, 6);
    let b = fixtures::matrix_mxn(6, 6);
    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syr2k('l', 't', 0, 0, 0.2, &a, 6, &b, 6, 0.3, &mut c, 6);
    approximately!(c, a);

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syr2k('l', 't', 6, 0, 0.3, &a, 6, &b, 6, 1.0, &mut c, 6);
    approximately!(c, b);

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syr2k('u', 'n', 6, 3, 0.0, &a, 6, &b, 6, 0.25, &mut c, 6);
    approximately!(
        c,
        vec![
            0.31573855876922607,
            -0.32623335719108582,
            1.3297992944717407,
            1.2724293470382690,
            0.41464143991470337,
            -1.5399500131607056,
            -0.23214176297187805,
            -7.3680110275745392E-002,
            -5.7671726681292057E-003,
            2.4046533107757568,
            0.76359343528747559,
            -0.79900926351547241,
            -0.28691425919532776,
            -7.2365395724773407E-002,
            -7.4803777039051056E-002,
            -0.41151082515716553,
            0.25222346186637878,
            -0.89192110300064087,
            0.10892082750797272,
            -0.30938461422920227,
            -5.6066971272230148E-002,
            9.4348914921283722E-002,
            0.13333636522293091,
            0.80418950319290161,
            -1.4276693575084209E-002,
            0.12590199708938599,
            0.27144235372543335,
            -0.17273846268653870,
            -0.32114982604980469,
            4.6726170927286148E-002,
            -5.8926638215780258E-002,
            -0.13572207093238831,
            -0.10832758247852325,
            -0.16236791014671326,
            0.18168768286705017,
            0.28797793388366699,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syr2k('u', 'n', 6, 3, 0.0, &a, 6, &b, 6, 0.0, &mut c, 6);
    approximately!(
        c,
        vec![
            0.0000000000000000,
            -0.32623335719108582,
            1.3297992944717407,
            1.2724293470382690,
            0.41464143991470337,
            -1.5399500131607056,
            0.0000000000000000,
            0.0000000000000000,
            -5.7671726681292057E-003,
            2.4046533107757568,
            0.76359343528747559,
            -0.79900926351547241,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            -0.41151082515716553,
            0.25222346186637878,
            -0.89192110300064087,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.13333636522293091,
            0.80418950319290161,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            4.6726170927286148E-002,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syr2k('l', 'n', 6, 3, 0.0, &a, 6, &b, 6, 0.0, &mut c, 6);
    approximately!(
        c,
        vec![
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            -0.92856705188751221,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            -1.1476570367813110,
            -0.28946158289909363,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.43568331003189087,
            -1.2375384569168091,
            -0.22426788508892059,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            0.0000000000000000,
            0.0000000000000000,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            0.0000000000000000,
        ]
    );
    let mut mat = fixtures::matrix_mxn(6, 6);
    mat[0] = 0.0;
    let a = mat.clone();
    let b = mat.clone();
    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syr2k('u', 'n', 6, 3, 0.3, &a, 6, &b, 6, -0.5, &mut c, 6);
    approximately!(
        c,
        vec![
            0.67613500077621813,
            -0.32623335719108582,
            1.3297992944717407,
            1.2724293470382690,
            0.41464143991470337,
            -1.5399500131607056,
            0.82780572855962076,
            0.31360603699103662,
            -5.7671726681292057E-003,
            2.4046533107757568,
            0.76359343528747559,
            -0.79900926351547241,
            0.78307944525089201,
            -6.2577560219526762E-002,
            1.2643650612588153,
            -0.41151082515716553,
            0.25222346186637878,
            -0.89192110300064087,
            -1.2742068218292955,
            1.5953520128125467E-002,
            1.1929366973896487,
            4.3537674391291237,
            0.13333636522293091,
            0.80418950319290161,
            -0.57055487819495898,
            -0.51179928384684603,
            -0.25997446702149285,
            1.7014690196431830,
            1.1334711513117268,
            4.6726170927286148E-002,
            1.1771852423451143,
            0.86907075736283956,
            -0.84914896579555577,
            -1.7835338663815290,
            -1.2475406493787211,
            1.7072752830771618,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syr2k('u', 'n', 6, 3, 0.3, &a, 6, &b, 6, 0.0, &mut c, 6);
    approximately!(
        c,
        vec![
            1.3076121183146703,
            -0.32623335719108582,
            1.3297992944717407,
            1.2724293470382690,
            0.41464143991470337,
            -1.5399500131607056,
            0.36352220261586454,
            0.16624581643954583,
            -5.7671726681292057E-003,
            2.4046533107757568,
            0.76359343528747559,
            -0.79900926351547241,
            0.20925092686023633,
            -0.20730835166907352,
            1.1147575071807132,
            -0.41151082515716553,
            0.25222346186637878,
            -0.89192110300064087,
            -1.0563651668133500,
            -0.60281570833027909,
            1.0808027548451884,
            4.5424652689716911,
            0.13333636522293091,
            0.80418950319290161,
            -0.59910826534512729,
            -0.25999528966807411,
            0.28291024042937385,
            1.3559920942701056,
            0.49117149921211745,
            4.6726170927286148E-002,
            1.0593319659135538,
            0.59762661549806295,
            -1.0658041307526023,
            -2.1082696866749555,
            -0.88416528364462077,
            2.2832311508444953,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syr2k('u', 'n', 6, 3, 0.3, &a, 6, &b, 6, 1.0, &mut c, 6);
    approximately!(
        c,
        vec![
            2.5705663533915750,
            -0.32623335719108582,
            1.3297992944717407,
            1.2724293470382690,
            0.41464143991470337,
            -1.5399500131607056,
            -0.56504484927164755,
            -0.12847462466343570,
            -5.7671726681292057E-003,
            2.4046533107757568,
            0.76359343528747559,
            -0.79900926351547241,
            -0.93840610992107454,
            -0.49676993456816732,
            0.81554239902450898,
            -0.41151082515716553,
            0.25222346186637878,
            -0.89192110300064087,
            -0.62068185678145893,
            -1.8403541652470881,
            0.85653486975626780,
            4.9198609286568260,
            0.13333636522293091,
            0.80418950319290161,
            -0.65621503964546413,
            0.24361269868946989,
            1.3686796553311074,
            0.66503824352395080,
            -0.79342780498710164,
            4.6726170927286148E-002,
            0.82362541305043280,
            5.4738331768509840E-002,
            -1.4991144606666955,
            -2.7577413272618081,
            -0.15741455217642017,
            3.4351428863791633,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syr2k('l', 'n', 6, 3, 0.3, &a, 6, &b, 6, 0.0, &mut c, 6);
    approximately!(
        c,
        vec![
            1.3076121183146703,
            0.36352220261586454,
            0.20925092686023633,
            -1.0563651668133500,
            -0.59910826534512729,
            1.0593319659135538,
            -0.92856705188751221,
            0.16624581643954583,
            -0.20730835166907352,
            -0.60281570833027909,
            -0.25999528966807411,
            0.59762661549806295,
            -1.1476570367813110,
            -0.28946158289909363,
            1.1147575071807132,
            1.0808027548451884,
            0.28291024042937385,
            -1.0658041307526023,
            0.43568331003189087,
            -1.2375384569168091,
            -0.22426788508892059,
            4.5424652689716911,
            1.3559920942701056,
            -2.1082696866749555,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            0.49117149921211745,
            -0.88416528364462077,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            2.2832311508444953,
        ],
        1E-5
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syr2k('l', 'n', 6, 3, 0.3, &a, 6, &b, 6, 0.5, &mut c, 6);
    approximately!(
        c,
        vec![
            1.9390892358531224,
            0.20040552402032166,
            0.87415057409610686,
            -0.42015049329421528,
            -0.39178754538777572,
            0.28935695933320105,
            -0.92856705188751221,
            1.8885595888055037E-002,
            -0.21019193800313812,
            0.59951094705759944,
            0.12180142797566368,
            0.19812198374032686,
            -1.1476570367813110,
            -0.28946158289909363,
            0.96514995310261109,
            0.87504734226660563,
            0.40902197136256324,
            -1.5117646822529229,
            0.43568331003189087,
            -1.2375384569168091,
            -0.22426788508892059,
            4.7311630988142586,
            1.4226602768815710,
            -1.7061749350785047,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -0.15112815288749185,
            -0.86080219818097770,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            2.8591870186118293,
        ],
        1E-5
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syr2k('l', 'n', 6, 3, 0.3, &a, 6, &b, 6, 1.0, &mut c, 6);
    approximately!(
        c,
        vec![
            2.5705663533915750,
            3.7288845424778727E-002,
            1.5390502213319772,
            0.21606418022491919,
            -0.18446682543042400,
            -0.48061804724715174,
            -0.92856705188751221,
            -0.12847462466343570,
            -0.21307552433720273,
            1.8018376024454774,
            0.50359814561940142,
            -0.20138264801740940,
            -1.1476570367813110,
            -0.28946158289909363,
            0.81554239902450898,
            0.66929192968802287,
            0.53513370229575252,
            -1.9577252337532434,
            0.43568331003189087,
            -1.2375384569168091,
            -0.22426788508892059,
            4.9198609286568260,
            1.4893284594930365,
            -1.3040801834820539,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -0.79342780498710164,
            -0.83743911271733462,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            3.4351428863791633,
        ],
        1E-5
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syr2k('u', 't', 6, 3, 0.3, &a, 6, &b, 6, 1.0, &mut c, 6);
    approximately!(
        c,
        vec![
            2.3878308999285087,
            -0.32623335719108582,
            1.3297992944717407,
            1.2724293470382690,
            0.41464143991470337,
            -1.5399500131607056,
            -0.87547997570480840,
            0.27475768264739653,
            -5.7671726681292057E-003,
            2.4046533107757568,
            0.76359343528747559,
            -0.79900926351547241,
            -1.3297354534690902,
            0.40216587366972201,
            0.59504554517674246,
            -0.41151082515716553,
            0.25222346186637878,
            -0.89192110300064087,
            0.49898034260056723,
            -1.2606623949744260,
            -0.26908238873116125,
            1.4403661798861700,
            0.13333636522293091,
            0.80418950319290161,
            0.71063026249390426,
            0.44261323446761236,
            0.84270053303736825,
            -1.2259246309817637,
            -0.42313282280087311,
            4.6726170927286148E-002,
            -0.47517106455435298,
            -0.31406712133026382,
            -9.8925166715819995E-002,
            -0.24967403926774986,
            0.28850019069079519,
            1.4747376141728323,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syr2k('u', 't', 6, 3, 0.3, &a, 6, &b, 6, 0.0, &mut c, 6);
    approximately!(
        c,
        vec![
            1.1248766648516044,
            -0.32623335719108582,
            1.3297992944717407,
            1.2724293470382690,
            0.41464143991470337,
            -1.5399500131607056,
            5.3087076182703856E-002,
            0.56947812375037810,
            -5.7671726681292057E-003,
            2.4046533107757568,
            0.76359343528747559,
            -0.79900926351547241,
            -0.18207841668777927,
            0.69162745656881564,
            0.89426065333294669,
            -0.41151082515716553,
            0.25222346186637878,
            -0.89192110300064087,
            6.3297032568676304E-002,
            -2.3123938057616780E-002,
            -4.4814503642240641E-002,
            1.0629705202010351,
            0.13333636522293091,
            0.80418950319290161,
            0.76773703679424110,
            -6.0994753889931551E-002,
            -0.24306888186436520,
            -0.53497078023560884,
            0.86146648139834558,
            4.6726170927286148E-002,
            -0.23946451169123192,
            0.22882116239928937,
            0.33438516319827299,
            0.39979760131910319,
            -0.43825054077740544,
            0.32282587863816453,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syr2k('u', 't', 6, 3, 0.3, &a, 6, &b, 6, 0.4, &mut c, 6);
    approximately!(
        c,
        vec![
            1.6300583664101600,
            -0.32623335719108582,
            1.3297992944717407,
            1.2724293470382690,
            0.41464143991470337,
            -1.5399500131607056,
            -0.31833975010699200,
            0.45158994555251475,
            -5.7671726681292057E-003,
            2.4046533107757568,
            0.76359343528747559,
            -0.79900926351547241,
            -0.64114123824087277,
            0.57584282168385270,
            0.77457460828700397,
            -0.41151082515716553,
            0.25222346186637878,
            -0.89192110300064087,
            0.23757035917830754,
            -0.51813932820064434,
            -0.13452165901454965,
            1.2139287863245425,
            0.13333636522293091,
            0.80418950319290161,
            0.74489432673372347,
            0.14044844445482357,
            0.19123889056801821,
            -0.81135232465247675,
            0.34762675206184956,
            4.6726170927286148E-002,
            -0.33374713424140090,
            1.1665845671601754E-002,
            0.16106102864990496,
            0.14000894121320934,
            -0.14755024385835325,
            0.78359057971796076,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syr2k('l', 't', 6, 3, 0.3, &a, 6, &b, 6, 0.0, &mut c, 6);
    approximately!(
        c,
        vec![
            1.1248766648516044,
            5.3087076182703856E-002,
            -0.18207841668777927,
            6.3297032568676304E-002,
            0.76773703679424110,
            -0.23946451169123192,
            -0.92856705188751221,
            0.56947812375037810,
            0.69162745656881564,
            -2.3123938057616780E-002,
            -6.0994753889931551E-002,
            0.22882116239928937,
            -1.1476570367813110,
            -0.28946158289909363,
            0.89426065333294669,
            -4.4814503642240641E-002,
            -0.24306888186436520,
            0.33438516319827299,
            0.43568331003189087,
            -1.2375384569168091,
            -0.22426788508892059,
            1.0629705202010351,
            -0.53497078023560884,
            0.39979760131910319,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            0.86146648139834558,
            -0.43825054077740544,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            0.32282587863816453,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syr2k('l', 't', 6, 3, 0.3, &a, 6, &b, 6, 0.2, &mut c, 6);
    approximately!(
        c,
        vec![
            1.3774675156308822,
            -1.2159596227764472E-002,
            8.3881446169679616E-002,
            0.31778290576846513,
            0.85066532601290956,
            -0.54745451891278174,
            -0.92856705188751221,
            0.51053403465144642,
            0.69047402201800234,
            0.45780673126395988,
            9.1723935443249333E-002,
            6.9019307314961725E-002,
            -1.1476570367813110,
            -0.28946158289909363,
            0.83441763080997533,
            -0.12711666990007159,
            -0.19262418873940496,
            0.15600093994001279,
            0.43568331003189087,
            -1.2375384569168091,
            -0.22426788508892059,
            1.1384496532627888,
            -0.50830350679364933,
            0.56063550435435494,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            0.60454661673009757,
            -0.42890530645269337,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            0.55320822917806267,
        ]
    );

    let a = vec![];
    let b = vec![];
    let result = std::panic::catch_unwind(|| {
        level3::syr2k('x', 'u', 6, 3, 0.3, &a, 6, &b, 6, 0.2, &mut vec![], 6);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::syr2k('l', 'x', 6, 3, 0.3, &a, 6, &b, 6, 0.2, &mut vec![], 6);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::syr2k('t', 'u', 6, 3, 0.3, &a, 2, &b, 6, 0.2, &mut vec![], 6);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::syr2k('t', 'u', 6, 3, 0.3, &a, 6, &b, 2, 0.2, &mut vec![], 6);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::syr2k('t', 'u', 6, 3, 0.3, &a, 6, &b, 6, 0.2, &mut vec![], 5);
    });
    assert!(result.is_err());
}

#[test]
fn syrk() {
    let a = fixtures::matrix_mxn(6, 6);
    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syrk('l', 't', 0, 3, 0.2, &a, 6, 1.0, &mut c, 6);
    approximately!(c, a);

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syrk('l', 't', 5, 0, 0.2, &a, 6, 1.0, &mut c, 6);
    approximately!(c, a);

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syrk('l', 't', 5, 3, 0.0, &a, 6, 0.25, &mut c, 6);
    approximately!(
        c,
        vec![
            0.31573855876922607,
            -8.1558339297771454E-002,
            0.33244982361793518,
            0.31810733675956726,
            0.10366035997867584,
            -1.5399500131607056,
            -0.92856705188751221,
            -7.3680110275745392E-002,
            -1.4417931670323014E-003,
            0.60116332769393921,
            0.19089835882186890,
            -0.79900926351547241,
            -1.1476570367813110,
            -0.28946158289909363,
            -7.4803777039051056E-002,
            -0.10287770628929138,
            6.3055865466594696E-002,
            -0.89192110300064087,
            0.43568331003189087,
            -1.2375384569168091,
            -0.22426788508892059,
            9.4348914921283722E-002,
            3.3334091305732727E-002,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -0.32114982604980469,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syrk('u', 't', 5, 3, 0.0, &a, 6, 0.0, &mut c, 6);
    approximately!(
        c,
        vec![
            0.0000000000000000,
            -0.32623335719108582,
            1.3297992944717407,
            1.2724293470382690,
            0.41464143991470337,
            -1.5399500131607056,
            0.0000000000000000,
            0.0000000000000000,
            -5.7671726681292057E-003,
            2.4046533107757568,
            0.76359343528747559,
            -0.79900926351547241,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            -0.41151082515716553,
            0.25222346186637878,
            -0.89192110300064087,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.13333636522293091,
            0.80418950319290161,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut mat = fixtures::matrix_mxn(6, 6);
    mat[0] = 0.0;
    let a = mat;

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syrk('u', 'n', 5, 3, 0.5, &a, 6, 0.0, &mut c, 6);
    approximately!(
        c,
        vec![
            1.0896767219623626,
            -0.32623335719108582,
            1.3297992944717407,
            1.2724293470382690,
            0.41464143991470337,
            -1.5399500131607056,
            0.30293515680899219,
            0.13853817486127573,
            -5.7671726681292057E-003,
            2.4046533107757568,
            0.76359343528747559,
            -0.79900926351547241,
            0.17437576545445990,
            -0.17275695285948342,
            0.92896455240352616,
            -0.41151082515716553,
            0.25222346186637878,
            -0.89192110300064087,
            -0.88030427069764272,
            -0.50234640364711325,
            0.90066892658162279,
            3.7853875737252878,
            0.13333636522293091,
            0.80418950319290161,
            -0.49925686794892066,
            -0.21666273278065828,
            0.23575852432294281,
            1.1299933669898525,
            0.40930956641226368,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syrk('l', 'n', 5, 3, 0.5, &a, 6, 0.1, &mut c, 6);
    approximately!(
        c,
        vec![
            1.2159721473520015,
            0.27031182060375802,
            0.30735569688318931,
            -0.75306133409774834,
            -0.45779272333958643,
            -1.5399500131607056,
            -0.92856705188751221,
            0.10906613031180989,
            -0.17333367013489009,
            -0.26188106898632491,
            -0.14030338811406784,
            -0.79900926351547241,
            -1.1476570367813110,
            -0.28946158289909363,
            0.89904304114204048,
            0.85951784345270732,
            0.26098087088542293,
            -0.89192110300064087,
            0.43568331003189087,
            -1.2375384569168091,
            -0.22426788508892059,
            3.8231271402561644,
            1.1433270037108323,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            0.28084963407813968,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syrk('l', 'n', 5, 3, 0.5, &a, 6, 1.0, &mut c, 6);
    approximately!(
        c,
        vec![
            2.3526309570392669,
            -2.3298200382093626E-002,
            1.5041750599262007,
            0.39212507634062632,
            -8.4615428034217288E-002,
            -1.5399500131607056,
            -0.92856705188751221,
            -0.15618226624170584,
            -0.17852412552761263,
            1.9023069071286436,
            0.54693070250681730,
            -0.79900926351547241,
            -1.1476570367813110,
            -0.28946158289909363,
            0.62974944424732193,
            0.48915810142445731,
            0.48798198618932154,
            -0.89192110300064087,
            0.43568331003189087,
            -1.2375384569168091,
            -0.22426788508892059,
            4.1627832334104227,
            1.2633297322127834,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -0.87528973778695507,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syrk('u', 't', 5, 3, 0.5, &a, 6, 1.0, &mut c, 6);
    approximately!(
        c,
        vec![
            2.2003514185377573,
            -0.32623335719108582,
            1.3297992944717407,
            1.2724293470382690,
            0.41464143991470337,
            -1.5399500131607056,
            -0.88432782349316796,
            0.17984464316481136,
            -5.7671726681292057E-003,
            2.4046533107757568,
            0.76359343528747559,
            -0.79900926351547241,
            -1.2993890446585055,
            0.28689460800591537,
            0.44600207334231445,
            -0.41151082515716553,
            0.25222346186637878,
            -0.89192110300064087,
            0.48843083507645613,
            -1.2568084045324375,
            -0.26161330330681420,
            1.2632043913204543,
            0.13333636522293091,
            0.80418950319290161,
            0.58267406427225765,
            0.45277902880236237,
            0.88321202139700339,
            -1.1367628165609722,
            -0.56671059822693159,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syrk('l', 't', 5, 3, 0.5, &a, 6, 1.0, &mut c, 6);
    approximately!(
        c,
        vec![
            2.2003514185377573,
            -0.28199412879674157,
            1.1780672865945463,
            1.3251768720828343,
            1.0544222784872979,
            -1.5399500131607056,
            -0.92856705188751221,
            0.17984464316481136,
            0.57058901823687980,
            2.3853833631601282,
            0.71276447573229396,
            -0.79900926351547241,
            -1.1476570367813110,
            -0.28946158289909363,
            0.44600207334231445,
            -0.44885624337505914,
            4.9666068361648774E-002,
            -0.89192110300064087,
            0.43568331003189087,
            -1.2375384569168091,
            -0.22426788508892059,
            1.2632043913204543,
            -0.31247260059188642,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -0.56671059822693159,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syrk('l', 't', 5, 3, 0.5, &a, 6, -0.3, &mut c, 6);
    approximately!(
        c,
        vec![
            0.55851089788219399,
            0.14210923944067463,
            -0.55067181207115956,
            -0.32898129423545530,
            0.51538840165527233,
            -1.5399500131607056,
            -0.92856705188751221,
            0.56298122011202878,
            0.57808634277419779,
            -0.74066596951405672,
            -0.27990699924416734,
            -0.79900926351547241,
            -1.1476570367813110,
            -0.28946158289909363,
            0.83498171751230199,
            8.6107834234847358E-002,
            -0.27822443507138162,
            -0.89192110300064087,
            0.43568331003189087,
            -1.2375384569168091,
            -0.22426788508892059,
            0.77259002923087217,
            -0.48580987697118994,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            1.1032685125456698,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut c = fixtures::matrix_mxn(6, 6);
    level3::syrk('l', 't', 5, 3, 0.5, &a, 6, 0., &mut c, 6);
    approximately!(
        c,
        vec![
            0.93739718346085299,
            4.4239228394344216E-002,
            -0.15173200787719443,
            5.2747525044565258E-002,
            0.63978083857259449,
            -1.5399500131607056,
            -0.92856705188751221,
            0.47456508426779292,
            0.57635619090500900,
            -1.9269947615628395E-002,
            -5.0828959555181574E-002,
            -0.79900926351547241,
            -1.1476570367813110,
            -0.28946158289909363,
            0.74521718149851868,
            -3.7345418217893611E-002,
            -0.20255739350473001,
            -0.89192110300064087,
            0.43568331003189087,
            -1.2375384569168091,
            -0.22426788508892059,
            0.88580873163531948,
            -0.44580896581481733,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            0.71788870597228716,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let a = vec![];
    let result = std::panic::catch_unwind(|| {
        level3::syrk('x', 't', 6, 3, 0.0, &a, 6, 0.0, &mut vec![], 6);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::syrk('l', 'x', 6, 3, 0.3, &a, 6, 0.2, &mut vec![], 6);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::syrk('t', 'u', 6, 3, 0.3, &a, 2, 0.2, &mut vec![], 6);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::syrk('t', 'u', 6, 3, 0.3, &a, 6, 0.2, &mut vec![], 5);
    });
    assert!(result.is_err());
}

#[test]
fn trmm() {
    let a = fixtures::matrix_mxn(6, 6);
    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trmm('l', 'u', 'n', 'u', 3, 0, 0.25, &a, 6, &mut b, 6);
    approximately!(b, a);

    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trmm('l', 'u', 'n', 'u', 0, 4, 0.25, &a, 6, &mut b, 6);
    approximately!(b, a);

    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trmm('l', 'u', 'n', 'u', 4, 5, 0.0, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.0,
            0.0,
            0.0,
            0.0,
            0.4146414344564082,
            -1.5399500419037095,
            0.0,
            0.0,
            0.0,
            0.0,
            0.7635934611404596,
            -0.7990092489893682,
            0.0,
            0.0,
            0.0,
            0.0,
            0.2522234481561323,
            -0.8919211272845686,
            0.0,
            0.0,
            0.0,
            0.0,
            0.1333363608148414,
            0.8041895097449078,
            0.0,
            0.0,
            0.0,
            0.0,
            -1.2845993538721883,
            0.04672617218835198,
            -0.23570655643950122,
            -0.5428882550102544,
            -0.4333103174567822,
            -0.6494716467962331,
            0.726750747385451,
            1.1519117540872
        ]
    );

    let data2 = vec![
        0.0,
        -0.3262333607056494,
        1.3297992629225006,
        1.2724293214294047,
        0.4146414344564082,
        -1.5399500419037095,
        -0.9285670347135381,
        -0.2947204467905602,
        -0.005767172747536955,
        2.404653388857951,
        0.7635934611404596,
        -0.7990092489893682,
        -1.1476570092363514,
        -0.28946157368822334,
        -0.29921511789731614,
        -0.411510832795067,
        0.2522234481561323,
        -0.8919211272845686,
        0.43568329935571865,
        -1.237538421929958,
        -0.22426788527830935,
        0.37739564598170106,
        0.1333363608148414,
        0.8041895097449078,
        -0.057106774383808755,
        0.5036079722337261,
        1.085769362145687,
        -0.6909538396968303,
        -1.2845993538721883,
        0.04672617218835198,
        -0.23570655643950122,
        -0.5428882550102544,
        -0.4333103174567822,
        -0.6494716467962331,
        0.726750747385451,
        1.1519117540872,
    ];
    b = data2.clone();
    level3::trmm('l', 'u', 'n', 'n', 4, 5, 0.2, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            -0.13376955027205623,
            -0.37269168964382426,
            -0.13665221769762764,
            9.6041863996781870E-002,
            0.41464143991470337,
            -1.5399500131607056,
            3.1043210583502262E-002,
            -0.57746429546569267,
            -0.10751217903927630,
            0.18150114721142990,
            0.76359343528747559,
            -0.79900926351547241,
            -0.20330918310617146,
            0.13623640118971414,
            3.6363669221485505E-002,
            -3.1060480328389754E-002,
            0.25222346186637878,
            -0.89192110300064087,
            0.42423863127033090,
            -7.4793651950806062E-003,
            -3.5066774415492968E-003,
            2.8485497214302609E-002,
            0.13333636522293091,
            0.80418950319290161,
            -0.41737700574272668,
            7.8473973225458224E-002,
            -3.3983971328727602E-002,
            -5.2152597640000117E-002,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    b = data2.clone();
    level3::trmm('l', 'u', 'n', 'u', 4, 5, 0.2, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            -0.13376955027205623,
            -0.45716789012760756,
            0.20888685428993503,
            0.25448587319978877,
            0.41464143991470337,
            -1.5399500131607056,
            7.9877339080526827E-002,
            -0.65378041250427499,
            -0.10901073863396238,
            0.48093066932157669,
            0.76359343528747559,
            -0.79900926351547241,
            -0.14295292655930192,
            6.1282034414110703E-002,
            -4.1385289758090887E-002,
            -8.2302166257830933E-002,
            0.25222346186637878,
            -0.89192110300064087,
            0.40132567662385932,
            -0.32793263733445327,
            -6.1781123226259227E-002,
            7.5479133061753689E-002,
            0.13333636522293091,
            0.80418950319290161,
            -0.41437371206720319,
            0.20888028653451660,
            0.24814563843818194,
            -0.13819077220843390,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    b = data2.clone();
    level3::trmm('l', 'l', 'n', 'n', 4, 5, 0.2, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.0000000000000000,
            1.9229528073314964E-002,
            -7.9202920304291768E-002,
            -0.17029912545531151,
            0.41464143991470337,
            -1.5399500131607056,
            -0.23454754164187250,
            7.7957938185309453E-002,
            -0.24627649999048579,
            -0.19607149801135446,
            0.76359343528747559,
            -0.79900926351547241,
            -0.28988766732341625,
            9.1942852051560969E-002,
            -0.28699089666230115,
            -0.43770788469578115,
            0.25222346186637878,
            -0.89192110300064087,
            0.11004961795128716,
            4.4518690863499522E-002,
            0.13072256109808894,
            -0.43735172082496909,
            0.13333636522293091,
            0.80418950319290161,
            -1.4424648705782278E-002,
            -2.5958687141488187E-002,
            -8.0744712265704510E-002,
            8.6153887050131550E-002,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    b = data2.clone();
    level3::trmm('l', 'l', 'n', 'u', 4, 5, 0.2, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.0000000000000000,
            -6.5246672410468332E-002,
            0.26633615168327091,
            -1.1855116252304621E-002,
            0.41464143991470337,
            -1.5399500131607056,
            -0.18571341314484791,
            1.6418211467271876E-003,
            -0.24777505958517188,
            0.10335802409879236,
            0.76359343528747559,
            -0.79900926351547241,
            -0.22953141077654671,
            1.6988485275957532E-002,
            -0.36473985564187755,
            -0.48894957062522237,
            0.25222346186637878,
            -0.89192110300064087,
            8.7136663304815620E-002,
            -0.27593458127587311,
            7.2448115313379025E-002,
            -0.39035808497751801,
            0.13333636522293091,
            0.80418950319290161,
            -1.1421355030258817E-002,
            0.10444762616757018,
            0.20138489750120506,
            1.1571248169774985E-004,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    b = data2.clone();
    level3::trmm('l', 'u', 't', 'n', 4, 5, 0.2, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.0000000000000000,
            1.9229528073314964E-002,
            -6.0692804055271013E-002,
            0.11714087432900773,
            0.41464143991470337,
            -1.5399500131607056,
            -0.23454754164187250,
            0.18981938447952956,
            0.23054247979735421,
            0.17379316805032069,
            0.76359343528747559,
            -0.79900926351547241,
            -0.28988766732341625,
            0.23019735475348149,
            0.29808687704124803,
            -4.5998647838143239E-002,
            0.25222346186637878,
            -0.89192110300064087,
            0.11004961795128716,
            -7.9666574884085968E-003,
            -1.4938167509753483E-002,
            0.38280899514826189,
            0.13333636522293091,
            0.80418950319290161,
            -1.4424648705782278E-002,
            -1.9079220167672776E-002,
            -8.1022958609228146E-002,
            -0.23047618662315555,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    b = data2.clone();
    level3::trmm('l', 'u', 't', 'u', 4, 5, 0.2, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.0000000000000000,
            -6.5246672410468332E-002,
            0.28484626793229167,
            0.27558488353201460,
            0.41464143991470337,
            -1.5399500131607056,
            -0.18571341314484791,
            0.11350326744094730,
            0.22904392020266814,
            0.47322269016046747,
            0.76359343528747559,
            -0.79900926351547241,
            -0.22953141077654671,
            0.15524298797787806,
            0.22033791806167161,
            -9.7240333767584411E-002,
            0.25222346186637878,
            -0.89192110300064087,
            8.7136663304815620E-002,
            -0.32841992962778122,
            -7.3212613294463408E-002,
            0.42980263099571292,
            0.13333636522293091,
            0.80418950319290161,
            -1.1421355030258817E-002,
            0.11132709314138559,
            0.20110665115768139,
            -0.31651436119158932,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    b = data2.clone();
    level3::trmm('l', 'l', 't', 'n', 4, 5, 0.2, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.69877417243773476,
            0.62964598915695558,
            -0.18430290080139067,
            9.6041863996781870E-002,
            0.41464143991470337,
            -1.5399500131607056,
            0.39509844751508305,
            1.1738502062335965,
            -0.19756305153203721,
            0.18150114721142990,
            0.76359343528747559,
            -0.79900926351547241,
            -0.45530416304997412,
            -0.18050100219891524,
            5.1774168805587273E-002,
            -3.1060480328389754E-002,
            0.25222346186637878,
            -0.89192110300064087,
            0.22719049228029489,
            0.25470540260658808,
            -1.7639612229834328E-002,
            2.8485497214302609E-002,
            0.13333636522293091,
            0.80418950319290161,
            6.5649696488754752E-002,
            -0.36323797600371394,
            -8.1087248501193320E-003,
            -5.2152597640000117E-002,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    b = data2.clone();
    level3::trmm('l', 'l', 't', 'u', 4, 5, 0.2, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.69877417243773476,
            0.54516978867317223,
            0.16123617118617201,
            0.25448587319978877,
            0.41464143991470337,
            -1.5399500131607056,
            0.44393257601210767,
            1.0975340891950143,
            -0.19906161112672330,
            0.48093066932157669,
            0.76359343528747559,
            -0.79900926351547241,
            -0.39494790650310457,
            -0.25545536897451870,
            -2.5974790173989123E-002,
            -8.2302166257830933E-002,
            0.25222346186637878,
            -0.89192110300064087,
            0.20427753763382334,
            -6.5747869532784525E-002,
            -7.5914058014544261E-002,
            7.5479133061753689E-002,
            0.13333636522293091,
            0.80418950319290161,
            6.8652990164278213E-002,
            -0.23283166269465555,
            0.27402088491679022,
            -0.13819077220843390,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    b = data2.clone();
    level3::trmm('r', 'u', 'n', 'n', 4, 5, 0.2, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.0000000000000000,
            -8.2403561245476389E-002,
            0.33589513515630032,
            0.32140401132491730,
            0.41464143991470337,
            -1.5399500131607056,
            5.4733539040789828E-002,
            7.7957938185309453E-002,
            -0.24662162503435850,
            -0.37804729602655435,
            0.76359343528747559,
            -0.79900926351547241,
            0.12243616443525157,
            0.10926510807652637,
            -0.28699089666230115,
            -0.40664740436739144,
            0.25222346186637878,
            -0.89192110300064087,
            0.31418901331904370,
            -3.5906251399439898E-002,
            0.11379501555798423,
            -0.43735172082496915,
            0.13333636522293091,
            0.80418950319290161,
            -0.38828049231206169,
            -4.7186895994017958E-002,
            -0.32870869118119039,
            0.26367365687583844,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let a = vec![
        1.2629542848807933,
        -0.3262333607056494,
        1.3297992629225006,
        1.2724293214294047,
        0.4146414344564082,
        -1.5399500419037095,
        -0.9285670347135381,
        -0.2947204467905602,
        -0.005767172747536955,
        2.404653388857951,
        0.7635934611404596,
        -0.7990092489893682,
        -1.1476570092363514,
        -0.28946157368822334,
        -0.29921511789731614,
        -0.411510832795067,
        0.2522234481561323,
        -0.8919211272845686,
        0.43568329935571865,
        -1.237538421929958,
        -0.22426788527830935,
        0.37739564598170106,
        0.1333363608148414,
        0.8041895097449078,
        0.0,
        0.5036079722337261,
        1.085769362145687,
        -0.6909538396968303,
        -1.2845993538721883,
        0.04672617218835198,
        -0.23570655643950122,
        -0.5428882550102544,
        -0.4333103174567822,
        -0.6494716467962331,
        0.726750747385451,
        1.1519117540872,
    ];

    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trmm('r', 'u', 'n', 'u', 4, 5, 0.2, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.25259085077927779,
            -6.5246672410468332E-002,
            0.26595986285745887,
            0.25448587319978877,
            0.41464143991470337,
            -1.5399500131607056,
            -0.42026095478672043,
            1.6418211467271876E-003,
            -0.24811500032477099,
            0.24462347229742959,
            0.76359343528747559,
            -0.79900926351547241,
            -0.46566217956546202,
            3.4050534609079502E-002,
            -0.36473985564187755,
            -0.51357562220354913,
            0.25222346186637878,
            -0.89192110300064087,
            0.47849029604446414,
            -0.19000561661229257,
            8.5868983411934455E-002,
            -0.39035808497751806,
            0.13333636522293091,
            0.80418950319290161,
            -0.41437371206720319,
            0.17919557239783579,
            0.18258903603362686,
            -3.7504017834857878E-002,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let a = vec![
        1.2629542848807933,
        0.0,
        1.3297992629225006,
        1.2724293214294047,
        0.4146414344564082,
        -1.5399500419037095,
        -0.9285670347135381,
        -0.2947204467905602,
        -0.005767172747536955,
        2.404653388857951,
        0.7635934611404596,
        -0.7990092489893682,
        -1.1476570092363514,
        -0.28946157368822334,
        -0.29921511789731614,
        -0.411510832795067,
        0.2522234481561323,
        -0.8919211272845686,
        0.43568329935571865,
        -1.237538421929958,
        -0.22426788527830935,
        0.37739564598170106,
        0.1333363608148414,
        0.8041895097449078,
        -0.057106774383808755,
        0.5036079722337261,
        1.085769362145687,
        -0.6909538396968303,
        -1.2845993538721883,
        0.04672617218835198,
        -0.23570655643950122,
        -0.5428882550102544,
        -0.4333103174567822,
        -0.6494716467962331,
        0.726750747385451,
        1.1519117540872,
    ];
    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trmm('r', 'l', 'n', 'n', 4, 5, 0.2, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.11991945712012861,
            -0.43256143005126935,
            0.28928391752242805,
            0.25070089192710987,
            0.41464143991470337,
            -1.5399500131607056,
            0.25686948050218156,
            -0.50055394354600868,
            5.8645043662170243E-002,
            -6.5285867462874403E-002,
            0.76359343528747559,
            -0.79900926351547241,
            2.9940851977806920E-002,
            0.14457870228456704,
            9.1134974160671095E-002,
            -4.1289383714462335E-002,
            0.25222346186637878,
            -0.89192110300064087,
            3.1362116565027028E-002,
            -7.9978477925575386E-002,
            1.2026964341996193E-002,
            1.0059641940680018E-002,
            0.13333636522293091,
            0.80418950319290161,
            1.4671864724882723E-002,
            -0.12938689621466881,
            -0.27895573113747618,
            0.17751976982570691,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trmm('r', 'l', 'n', 'u', 4, 5, 0.2, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            5.3499623166039158E-002,
            -0.41540454121626136,
            0.21934864522358660,
            0.18378275380198134,
            0.41464143991470337,
            -1.5399500131607056,
            1.6422528316543793E-002,
            -0.57687006058459112,
            5.7151668371757752E-002,
            0.55738490086110959,
            0.76359343528747559,
            -0.79900926351547241,
            -0.26826982469949034,
            6.9364128817120160E-002,
            1.3386015181094696E-002,
            -0.14821760155062005,
            0.25222346186637878,
            -0.89192110300064087,
            8.5613781339160269E-002,
            -0.23407784313842803,
            -1.5899067804053583E-002,
            5.7053277788131102E-002,
            0.13333636522293091,
            0.80418950319290161,
            -1.1421355030258817E-002,
            0.10072159917237755,
            0.21715388621619169,
            -0.13819077220843390,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let a = vec![
        1.2629542848807933,
        -0.3262333607056494,
        1.3297992629225006,
        1.2724293214294047,
        0.4146414344564082,
        -1.5399500419037095,
        0.0,
        -0.2947204467905602,
        -0.005767172747536955,
        2.404653388857951,
        0.7635934611404596,
        -0.7990092489893682,
        -1.1476570092363514,
        -0.28946157368822334,
        -0.29921511789731614,
        -0.411510832795067,
        0.2522234481561323,
        -0.8919211272845686,
        0.43568329935571865,
        -1.237538421929958,
        -0.22426788527830935,
        0.37739564598170106,
        0.1333363608148414,
        0.8041895097449078,
        -0.057106774383808755,
        0.5036079722337261,
        1.085769362145687,
        -0.6909538396968303,
        -1.2845993538721883,
        0.04672617218835198,
        -0.23570655643950122,
        -0.5428882550102544,
        -0.4333103174567822,
        -0.6494716467962331,
        0.726750747385451,
        1.1519117540872,
    ];
    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trmm('r', 'u', 't', 'n', 4, 5, 0.2, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.62105025011110615,
            -0.12954989323526214,
            0.37263148789538547,
            0.45663529934264102,
            0.41464143991470337,
            -1.5399500131607056,
            7.5872070510040876E-003,
            0.39115412276144135,
            0.18253065588284567,
            -0.28091909034151730,
            0.76359343528747559,
            -0.79900926351547241,
            3.6736352739085119E-002,
            0.18219071514324656,
            0.26374420144354255,
            -0.14234480784734793,
            0.25222346186637878,
            -0.89192110300064087,
            4.0776627769578674E-002,
            -0.16300230666012616,
            -0.16697085942567472,
            0.12396894340930473,
            0.13333636522293091,
            0.80418950319290161,
            1.4671864724882723E-002,
            -0.12938689621466881,
            -0.27895573113747618,
            0.17751976982570691,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trmm('r', 'u', 't', 'u', 4, 5, 1.0, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            2.7731520394618983,
            -0.56196501362733908,
            1.5134810554300948,
            1.9485857770513717,
            0.41464143991470337,
            -1.5399500131607056,
            -1.1642987083237655,
            1.5741900051570363,
            0.90518638947383767,
            1.7087583644498494,
            0.76359343528747559,
            -0.79900926351547241,
            -1.3073716002097058,
            0.53488070040865487,
            0.92997619846210555,
            -1.2463651098452408,
            0.25222346186637878,
            -0.89192110300064087,
            0.47514145563840016,
            -1.5855083357389788,
            -0.97448444333767270,
            0.85481288354607443,
            0.13333636522293091,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let a = vec![
        1.2629542848807933,
        -0.3262333607056494,
        1.3297992629225006,
        1.2724293214294047,
        0.4146414344564082,
        -1.5399500419037095,
        -0.9285670347135381,
        -0.2947204467905602,
        -0.005767172747536955,
        2.404653388857951,
        0.7635934611404596,
        -0.7990092489893682,
        -1.1476570092363514,
        -0.28946157368822334,
        -0.29921511789731614,
        -0.411510832795067,
        0.2522234481561323,
        -0.8919211272845686,
        0.43568329935571865,
        -1.237538421929958,
        -0.22426788527830935,
        0.37739564598170106,
        0.0,
        0.8041895097449078,
        -0.057106774383808755,
        0.5036079722337261,
        1.085769362145687,
        -0.6909538396968303,
        -1.2845993538721883,
        0.04672617218835198,
        -0.23570655643950122,
        -0.5428882550102544,
        -0.4333103174567822,
        -0.6494716467962331,
        0.726750747385451,
        1.1519117540872,
    ];

    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trmm('r', 'l', 't', 'n', 4, 5, 0.2, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.31901068473336724,
            -8.2403561245476389E-002,
            0.33589513515630032,
            0.32140401132491730,
            0.41464143991470337,
            -1.5399500131607056,
            -2.7670022204686562E-002,
            3.8657668925664676E-002,
            -8.6425038198470444E-002,
            -0.22476187977407930,
            0.76359343528747559,
            -0.79900926351547241,
            0.40564544237744482,
            -6.9102782173505045E-002,
            0.37158582649847066,
            0.36026757600105430,
            0.25222346186637878,
            -0.89192110300064087,
            2.1672963295202297E-003,
            -0.29434689431172434,
            0.34334003046094957,
            1.5426405492670858,
            0.13333636522293091,
            0.80418950319290161,
            -8.0296251354088660E-002,
            -0.21605199061834265,
            -0.18465232000306878,
            0.62951712335693322,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trmm('r', 'l', 't', 'u', 4, 5, 1.0, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            1.2629542350769043,
            -0.32623335719108582,
            1.3297992944717407,
            1.2724293470382690,
            0.41464143991470337,
            -1.5399500131607056,
            -1.3405848519753505,
            -0.18829223775881498,
            -0.43959206089398251,
            1.9895444131030011,
            0.76359343528747559,
            -0.79900926351547241,
            0.53717382049622420,
            -0.72158676745227890,
            1.4691843157019191,
            1.2666967719492299,
            0.25222346186637878,
            -0.89192110300064087,
            0.28209480131472731,
            -2.2422312642110356,
            1.5770699680743250,
            7.9481708071357104,
            0.13333636522293091,
            0.80418950319290161,
            -0.53194734761951779,
            7.0282522796227376E-002,
            1.5572864635476189,
            1.5690328832335503,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let a = vec![];
    let result = std::panic::catch_unwind(|| {
        level3::trmm('x', 'u', 'n', 'u', 3, 5, 0.25, &a, 6, &mut vec![], 6);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::trmm('l', 'x', 'n', 'u', 3, 5, 0.25, &a, 6, &mut vec![], 6);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::trmm('l', 'u', 'x', 'u', 3, 5, 0.25, &a, 6, &mut vec![], 6);
    });
    assert!(result.is_err());
    let result = std::panic::catch_unwind(|| {
        level3::trmm('l', 'u', 'n', 'x', 3, 5, 0.25, &a, 6, &mut vec![], 6);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::trmm('l', 'u', 'n', 'u', 3, 5, 0.25, &a, 2, &mut vec![], 6);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::trmm('l', 'u', 'n', 'u', 4, 5, 0.25, &a, 6, &mut vec![], 3);
    });
    assert!(result.is_err());
}

#[test]
fn trsm() {
    let a = fixtures::matrix_mxn(6, 6);
    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trsm('l', 'l', 'n', 'n', 3, 0, 0.2, &a, 6, &mut b, 6);
    approximately!(b, a);

    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trsm('l', 'u', 'n', 'u', 0, 4, 0.25, &a, 6, &mut b, 6);
    approximately!(b, a);

    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trsm('l', 'u', 'n', 'u', 5, 4, 0.0, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            -1.5399500131607056,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            -0.79900926351547241,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            -0.89192110300064087,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.0000000000000000,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trsm('l', 'u', 'n', 'n', 5, 4, -0.3, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            2.8760477856849080,
            1.0674914099744215,
            2.3099160037069781,
            -0.83419411218394646,
            9.6833648057177424E-002,
            -1.5399500131607056,
            6.0136168281204476,
            4.8635866076512668,
            1.8293225267512880,
            -1.5850226571227222,
            0.17832645474752631,
            -0.79900926351547241,
            -1.4371747372957879,
            -1.6154974071937465,
            -0.41226915389269775,
            0.43496171252302679,
            5.8903224779356549E-002,
            -0.89192110300064087,
            -0.14203359997494031,
            -0.25518927999139956,
            7.0263741446830702E-002,
            -0.24298957861021067,
            3.1138823620419129E-002,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut b = vec![
        1.2629542848807933,
        -0.3262333607056494,
        1.3297992629225006,
        1.2724293214294047,
        0.0,
        -1.5399500419037095,
        -0.9285670347135381,
        -0.2947204467905602,
        -0.005767172747536955,
        2.404653388857951,
        0.7635934611404596,
        -0.7990092489893682,
        -1.1476570092363514,
        -0.28946157368822334,
        -0.29921511789731614,
        -0.411510832795067,
        0.2522234481561323,
        -0.8919211272845686,
        0.43568329935571865,
        -1.237538421929958,
        -0.22426788527830935,
        0.37739564598170106,
        0.1333363608148414,
        0.8041895097449078,
        -0.057106774383808755,
        0.5036079722337261,
        1.085769362145687,
        -0.6909538396968303,
        -1.2845993538721883,
        0.04672617218835198,
        -0.23570655643950122,
        -0.5428882550102544,
        -0.4333103174567822,
        -0.6494716467962331,
        0.726750747385451,
        1.1519117540872,
    ];
    level3::trsm('l', 'u', 'n', 'u', 5, 4, 1.0, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            4.1556304884584154,
            1.7159749179671806,
            1.6151643330570895,
            1.2724293470382690,
            0.0000000000000000,
            -1.5399500131607056,
            0.32527101830242566,
            2.8982091011989999,
            -0.17724156678261460,
            2.9322611352921228,
            0.76359343528747559,
            -0.79900926351547241,
            -2.5763265232150987,
            -0.89135493070048955,
            -0.62627605662926944,
            -0.23723605293206518,
            0.25222346186637878,
            -0.89192110300064087,
            -0.80678160482835470,
            -0.79997545952292404,
            -0.26374106824485594,
            0.46952493468041467,
            0.13333636522293091,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut b = vec![
        0.0,
        -0.3262333607056494,
        1.3297992629225006,
        1.2724293214294047,
        0.4146414344564082,
        -1.5399500419037095,
        -0.9285670347135381,
        -0.2947204467905602,
        -0.005767172747536955,
        2.404653388857951,
        0.7635934611404596,
        -0.7990092489893682,
        -1.1476570092363514,
        -0.28946157368822334,
        -0.29921511789731614,
        -0.411510832795067,
        0.2522234481561323,
        -0.8919211272845686,
        0.43568329935571865,
        -1.237538421929958,
        -0.22426788527830935,
        0.37739564598170106,
        0.1333363608148414,
        0.8041895097449078,
        -0.057106774383808755,
        0.5036079722337261,
        1.085769362145687,
        -0.6909538396968303,
        -1.2845993538721883,
        0.04672617218835198,
        -0.23570655643950122,
        -0.5428882550102544,
        -0.4333103174567822,
        -0.6494716467962331,
        0.726750747385451,
        1.1519117540872,
    ];
    level3::trsm('l', 'l', 'n', 'n', 5, 4, 1.0, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.0000000000000000,
            1.1069247724052265,
            -4.4656271837292438,
            -8.5506942544560935,
            -1.4291268756368971,
            -1.5399500131607056,
            -0.73523412495700569,
            1.8138488664325891,
            -3.2832814948133882,
            -6.2867622079499208,
            -1.0507428478614336,
            -0.79900926351547241,
            -0.90870833234224635,
            1.9880282164136940,
            -3.0768830449084668,
            -14.048738644337698,
            -1.3702608528785267,
            -0.89192110300064087,
            0.34497157373668497,
            3.8171672723850882,
            2.2091016117699600,
            -22.076170652817265,
            0.41888386278645928,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut b = vec![
        0.0,
        -0.3262333607056494,
        1.3297992629225006,
        1.2724293214294047,
        0.4146414344564082,
        -1.5399500419037095,
        -0.9285670347135381,
        -0.2947204467905602,
        -0.005767172747536955,
        2.404653388857951,
        0.7635934611404596,
        -0.7990092489893682,
        -1.1476570092363514,
        -0.28946157368822334,
        -0.29921511789731614,
        -0.411510832795067,
        0.2522234481561323,
        -0.8919211272845686,
        0.43568329935571865,
        -1.237538421929958,
        -0.22426788527830935,
        0.37739564598170106,
        0.1333363608148414,
        0.8041895097449078,
        -0.057106774383808755,
        0.5036079722337261,
        1.085769362145687,
        -0.6909538396968303,
        -1.2845993538721883,
        0.04672617218835198,
        -0.23570655643950122,
        -0.5428882550102544,
        -0.4333103174567822,
        -0.6494716467962331,
        0.726750747385451,
        1.1519117540872,
    ];
    level3::trsm('l', 'l', 'n', 'u', 5, 4, 0.4, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.0000000000000000,
            -0.13049334482093666,
            0.53116714806329368,
            1.0413440314533495,
            -7.3214051234893329E-003,
            -1.5399500131607056,
            -0.37142682628969581,
            -0.23905999868918107,
            0.49023756215580533,
            2.2110702137392075,
            0.22352549776441472,
            -0.79900926351547241,
            -0.45906282155309341,
            -0.26554624032184093,
            0.48924392015425894,
            1.2593964890024612,
            0.20268307600853525,
            -0.89192110300064087,
            0.17427332660963124,
            -0.43816161773430906,
            -0.32398265584906044,
            0.84951218563403830,
            0.28409609869451813,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trsm('l', 'u', 't', 'n', 5, 4, 0.4, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.40000000596046448,
            -0.81749837427995664,
            -2.5210898556555987,
            -3.2920006232504653,
            -0.82757303929373927,
            -1.5399500131607056,
            -0.29409365436513918,
            1.3265922592519162,
            -0.14762614926240678,
            7.1505702288184647,
            -3.6755135679883280,
            -0.79900926351547241,
            -0.36348333835322227,
            1.5380788827994862,
            0.30621952409281056,
            5.2090325188076907,
            -2.0023835360962079,
            -0.89192110300064087,
            0.13798863155086480,
            1.2448532310035869,
            -1.4337299275752455,
            3.4707688249874709,
            -2.6382839997206511,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut b = vec![
        1.2629542848807933,
        -0.3262333607056494,
        1.3297992629225006,
        1.2724293214294047,
        0.0,
        -1.5399500419037095,
        -0.9285670347135381,
        -0.2947204467905602,
        -0.005767172747536955,
        2.404653388857951,
        0.7635934611404596,
        -0.7990092489893682,
        -1.1476570092363514,
        -0.28946157368822334,
        -0.29921511789731614,
        -0.411510832795067,
        0.2522234481561323,
        -0.8919211272845686,
        0.43568329935571865,
        -1.237538421929958,
        -0.22426788527830935,
        0.37739564598170106,
        0.1333363608148414,
        0.8041895097449078,
        -0.057106774383808755,
        0.5036079722337261,
        1.085769362145687,
        -0.6909538396968303,
        -1.2845993538721883,
        0.04672617218835198,
        -0.23570655643950122,
        -0.5428882550102544,
        -0.4333103174567822,
        -0.6494716467962331,
        0.726750747385451,
        1.1519117540872,
    ];
    level3::trsm('l', 'u', 't', 'u', 5, 4, 1.0, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            1.2629542350769043,
            0.84650433354312327,
            3.0242680938088427,
            2.4480091415279279,
            -1.9463795578177014,
            -1.5399500131607056,
            -0.92856705188751221,
            -1.1569572109540474,
            -1.4063383495193884,
            1.0620389085996593,
            3.5539979003076425,
            -0.79900926351547241,
            -1.1476570367813110,
            -1.3551380941210738,
            -2.0085922000010106,
            -2.0389940391990007,
            1.6411600347579820,
            -0.89192110300064087,
            0.43568331003189087,
            -0.83297729016390321,
            3.4632206547511479E-002,
            -0.83549882555301869,
            -3.7182870327288287E-002,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut b = vec![
        0.0,
        -0.3262333607056494,
        1.3297992629225006,
        1.2724293214294047,
        0.4146414344564082,
        -1.5399500419037095,
        -0.9285670347135381,
        -0.2947204467905602,
        -0.005767172747536955,
        2.404653388857951,
        0.7635934611404596,
        -0.7990092489893682,
        -1.1476570092363514,
        -0.28946157368822334,
        -0.29921511789731614,
        -0.411510832795067,
        0.2522234481561323,
        -0.8919211272845686,
        0.43568329935571865,
        -1.237538421929958,
        -0.22426788527830935,
        0.37739564598170106,
        0.1333363608148414,
        0.8041895097449078,
        -0.057106774383808755,
        0.5036079722337261,
        1.085769362145687,
        -0.6909538396968303,
        -1.2845993538721883,
        0.04672617218835198,
        -0.23570655643950122,
        -0.5428882550102544,
        -0.4333103174567822,
        -0.6494716467962331,
        0.726750747385451,
        1.1519117540872,
    ];
    level3::trsm('l', 'l', 't', 'n', 5, 4, 1.0, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            14.071953442027016,
            28.896460512105627,
            -9.5101901017120269,
            3.4856455476188124,
            -0.32277881403118042,
            -1.5399500131607056,
            16.647190236328399,
            53.347344958219551,
            -9.5336347064703304,
            6.5817166896649049,
            -0.59442149220489982,
            -0.79900926351547241,
            -4.2136696115120111,
            -7.9010181993490969,
            2.2387106134601513,
            -1.0210266334602636,
            -0.19634407479584262,
            -0.89192110300064087,
            3.3426373540889309,
            12.403351630523389,
            -0.76371010732187516,
            1.0366718348708222,
            -0.10379607461024500,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ],
        1E-5
    );

    let mut b = vec![
        0.0,
        -0.3262333607056494,
        1.3297992629225006,
        1.2724293214294047,
        0.4146414344564082,
        -1.5399500419037095,
        -0.9285670347135381,
        -0.2947204467905602,
        -0.005767172747536955,
        2.404653388857951,
        0.7635934611404596,
        -0.7990092489893682,
        -1.1476570092363514,
        -0.28946157368822334,
        -0.29921511789731614,
        -0.411510832795067,
        0.2522234481561323,
        -0.8919211272845686,
        0.43568329935571865,
        -1.237538421929958,
        -0.22426788527830935,
        0.37739564598170106,
        0.1333363608148414,
        0.8041895097449078,
        -0.057106774383808755,
        0.5036079722337261,
        1.085769362145687,
        -0.6909538396968303,
        -1.2845993538721883,
        0.04672617218835198,
        -0.23570655643950122,
        -0.5428882550102544,
        -0.4333103174567822,
        -0.6494716467962331,
        0.726750747385451,
        1.1519117540872,
    ];
    level3::trsm('l', 'l', 't', 'u', 5, 4, 0.4, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            -2.0709179287349446,
            -1.4238808651692094,
            0.69043374474546071,
            0.48685703308243111,
            0.16585657843733692,
            -1.5399500131607056,
            -2.9053033457793012,
            -2.5644010238629114,
            0.29971185824180141,
            0.92113542876856069,
            0.30543737866636178,
            -0.79900926351547241,
            9.2468575755851989E-002,
            0.23408160147934709,
            -0.21840491582933022,
            -0.17805655656779862,
            0.10088938624992050,
            -0.89192110300064087,
            -0.26011598121513951,
            -0.88189661251917384,
            -4.3964851097145805E-002,
            0.14384683150119362,
            5.3334546883919032E-002,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trsm('r', 'u', 'n', 'n', 5, 4, 0.4, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.40000000596046448,
            -0.10332389028569243,
            0.42117102183241650,
            0.40300094196887909,
            0.13132429808688795,
            -1.5399500131607056,
            -0.0000000000000000,
            0.72553955738441744,
            -1.3191438758939147,
            -4.5333629735177849,
            -1.4501226768752162,
            -0.79900926351547241,
            -0.0000000000000000,
            8.1376893207696338E-002,
            6.0717631042909850E-002,
            3.3899755064395092,
            0.56197083573963380,
            -0.89192110300064087,
            0.0000000000000000,
            1.2351345873541026,
            -5.0135144737906154,
            -12.916340648551534,
            -4.4315078463190725,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );
    let a = vec![
        1.2629542848807933,
        -0.3262333607056494,
        1.3297992629225006,
        1.2724293214294047,
        0.4146414344564082,
        -1.5399500419037095,
        0.0,
        -0.2947204467905602,
        -0.005767172747536955,
        2.404653388857951,
        0.7635934611404596,
        -0.7990092489893682,
        -1.1476570092363514,
        -0.28946157368822334,
        -0.29921511789731614,
        -0.411510832795067,
        0.2522234481561323,
        -0.8919211272845686,
        0.43568329935571865,
        -1.237538421929958,
        -0.22426788527830935,
        0.37739564598170106,
        0.1333363608148414,
        0.8041895097449078,
        -0.057106774383808755,
        0.5036079722337261,
        1.085769362145687,
        -0.6909538396968303,
        -1.2845993538721883,
        0.04672617218835198,
        -0.23570655643950122,
        -0.5428882550102544,
        -0.4333103174567822,
        -0.6494716467962331,
        0.726750747385451,
        1.1519117540872,
    ];

    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trsm('r', 'u', 'n', 'u', 5, 4, 1.0, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            1.2629542350769043,
            -0.32623335719108582,
            1.3297992944717407,
            1.2724293470382690,
            0.41464143991470337,
            -1.5399500131607056,
            -0.92856705188751221,
            -0.29472044110298157,
            -5.7671726681292057E-003,
            2.4046533107757568,
            0.76359343528747559,
            -0.79900926351547241,
            3.2996789570152174E-002,
            -0.74917583630662232,
            1.2252690347217428,
            1.7448564224390495,
            0.94912059259529258,
            -0.89192110300064087,
            -1.2563020878502498,
            -1.6281479882856154,
            -0.53598784626494267,
            3.1901856372673363,
            1.1105175198176607,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trsm('r', 'l', 'n', 'n', 5, 4, 1.0, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.70564268894473470,
            -9.4021146266978111,
            -1.5183813183635133,
            0.0000000000000000,
            1.4536198850814033,
            -1.5399500131607056,
            12.525932259284879,
            -25.862121989332273,
            -4.8645484671667072,
            -0.0000000000000000,
            0.31775908685034171,
            -0.79900926351547241,
            2.2478463015809740,
            5.4772264960486572,
            1.8172744690943989,
            -0.0000000000000000,
            -1.3288531503707177,
            -0.89192110300064087,
            1.1544470606667443,
            -3.2791539201836617,
            -0.59425136281649238,
            1.0000000000000000,
            0.35330656779194236,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let a = vec![
        1.2629542848807933,
        -0.3262333607056494,
        1.3297992629225006,
        1.2724293214294047,
        0.4146414344564082,
        -1.5399500419037095,
        -0.9285670347135381,
        -0.2947204467905602,
        -0.005767172747536955,
        2.404653388857951,
        0.7635934611404596,
        -0.7990092489893682,
        -1.1476570092363514,
        -0.28946157368822334,
        -0.29921511789731614,
        0.0,
        0.2522234481561323,
        -0.8919211272845686,
        0.43568329935571865,
        -1.237538421929958,
        -0.22426788527830935,
        0.37739564598170106,
        0.1333363608148414,
        0.8041895097449078,
        -0.057106774383808755,
        0.5036079722337261,
        1.085769362145687,
        -0.6909538396968303,
        -1.2845993538721883,
        0.04672617218835198,
        -0.23570655643950122,
        -0.5428882550102544,
        -0.4333103174567822,
        -0.6494716467962331,
        0.726750747385451,
        1.1519117540872,
    ];

    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trsm('r', 'l', 'n', 'u', 5, 4, 0.4, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.63514348901234075,
            1.0030009359941672,
            0.87461970167237335,
            0.73083684628214940,
            2.1823395109519889E-002,
            -1.5399500131607056,
            -0.79314125265886570,
            1.0717844686128233,
            0.21271748897692591,
            0.59790974261275354,
            0.17776813043410594,
            -0.79900926351547241,
            -0.45906282155309341,
            -0.11578463488496293,
            -0.11968604504594271,
            -0.16460433251566187,
            0.10088938624992050,
            -0.89192110300064087,
            0.17427332660963124,
            -0.49501539014302764,
            -8.9707155372309000E-002,
            0.15095826612350738,
            5.3334546883919032E-002,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let a = vec![
        1.2629542848807933,
        -0.3262333607056494,
        1.3297992629225006,
        1.2724293214294047,
        0.4146414344564082,
        -1.5399500419037095,
        -0.9285670347135381,
        -0.2947204467905602,
        -0.005767172747536955,
        2.404653388857951,
        0.7635934611404596,
        -0.7990092489893682,
        -1.1476570092363514,
        -0.28946157368822334,
        -0.29921511789731614,
        -0.411510832795067,
        0.2522234481561323,
        -0.8919211272845686,
        0.0,
        -1.237538421929958,
        -0.22426788527830935,
        0.37739564598170106,
        0.1333363608148414,
        0.8041895097449078,
        -0.057106774383808755,
        0.5036079722337261,
        1.085769362145687,
        -0.6909538396968303,
        -1.2845993538721883,
        0.04672617218835198,
        -0.23570655643950122,
        -0.5428882550102544,
        -0.4333103174567822,
        -0.6494716467962331,
        0.726750747385451,
        1.1519117540872,
    ];

    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trsm('r', 'u', 't', 'n', 5, 4, 0.4, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.12265160515110517,
            4.4958660707110338,
            1.2686519464434949,
            -3.1847383241640368,
            -1.1496261325400379,
            -1.5399500131607056,
            -1.8456630500063393,
            4.5620681112929500,
            0.43809281388119808,
            -5.1890953824761556,
            -1.1945825060805559,
            -0.79900926351547241,
            1.1881106602650842,
            1.3700785619373967,
            0.57816146198746388,
            0.25031215036191640,
            -0.44310434134787979,
            -0.89192110300064087,
            0.46177883114773843,
            -1.3116615876187452,
            -0.23770054866861109,
            0.40000000596046448,
            0.14132262922264818,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trsm('r', 'u', 't', 'u', 5, 4, 1.0, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            -0.58581143455533968,
            -2.8251275929335362,
            0.57166729880208988,
            3.4759940329914816,
            1.6765266814553499,
            -1.5399500131607056,
            -0.69331159718403756,
            -1.9903470874821614,
            -0.38447736812125505,
            2.7770777485476015,
            1.0102671058949777,
            -0.79900926351547241,
            -1.0499472622719184,
            -0.56700171534803268,
            -0.34951119243846152,
            -0.32687309871784231,
            0.28212652650036940,
            -0.89192110300064087,
            0.43568331003189087,
            -1.2375384569168091,
            -0.22426788508892059,
            0.37739565968513489,
            0.13333636522293091,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ]
    );

    let a = vec![
        1.2629542848807933,
        0.0,
        1.3297992629225006,
        1.2724293214294047,
        0.4146414344564082,
        -1.5399500419037095,
        -0.9285670347135381,
        -0.2947204467905602,
        -0.005767172747536955,
        2.404653388857951,
        0.7635934611404596,
        -0.7990092489893682,
        -1.1476570092363514,
        -0.28946157368822334,
        -0.29921511789731614,
        -0.411510832795067,
        0.2522234481561323,
        -0.8919211272845686,
        0.43568329935571865,
        -1.237538421929958,
        -0.22426788527830935,
        0.37739564598170106,
        0.1333363608148414,
        0.8041895097449078,
        -0.057106774383808755,
        0.5036079722337261,
        1.085769362145687,
        -0.6909538396968303,
        -1.2845993538721883,
        0.04672617218835198,
        -0.23570655643950122,
        -0.5428882550102544,
        -0.4333103174567822,
        -0.6494716467962331,
        0.726750747385451,
        1.1519117540872,
    ];
    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trsm('r', 'l', 't', 'n', 5, 4, 1.0, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            1.0000000000000000,
            -0.25830972186511630,
            1.0529275388911983,
            1.0075023399092429,
            0.32831074032500862,
            -1.5399500131607056,
            3.1506706776509308,
            1.0000000000000000,
            1.9568281882809863E-002,
            -8.1590991848967818,
            -2.5909076154668886,
            -0.79900926351547241,
            8.2191233076063988,
            -0.19987518688139722,
            5.6791402122517267,
            6.0101967138102479,
            0.66609651430713834,
            -0.89192110300064087,
            -13.330197021871951,
            -8.9978822302334489,
            1.9235222679509523,
            56.143957802321914,
            16.481176946121465,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ],
        1E-5
    );

    let mut b = fixtures::matrix_mxn(6, 6);
    level3::trsm('r', 'l', 't', 'u', 5, 4, 0.4, &a, 6, &mut b, 6);
    approximately!(
        b,
        vec![
            0.50518170155855557,
            -0.13049334482093666,
            0.53191972571491775,
            0.50897174639957754,
            0.16585657843733692,
            -1.5399500131607056,
            -0.37142682628969581,
            -0.11788817819786335,
            -2.3068691016267101E-003,
            0.96186133864315337,
            0.30543737866636178,
            -0.79900926351547241,
            -1.1329951745064821,
            5.7065441511977961E-002,
            -0.82704582512967395,
            -0.83588738136111684,
            -0.11790506463747739,
            -0.89192110300064087,
            -4.1621727652003587E-002,
            -2.2008583670317005E-002,
            -1.1013285141596649,
            -3.1535920793264705,
            -0.94069644520301565,
            0.80418950319290161,
            -5.7106774300336838E-002,
            0.50360798835754395,
            1.0857694149017334,
            -0.69095385074615479,
            -1.2845993041992188,
            4.6726170927286148E-002,
            -0.23570655286312103,
            -0.54288828372955322,
            -0.43331032991409302,
            -0.64947164058685303,
            0.72675073146820068,
            1.1519117355346680,
        ],
        1E-5
    );

    let a = vec![];
    let result = std::panic::catch_unwind(|| {
        level3::trsm('x', 'u', 'n', 'u', 3, 5, 0.25, &a, 6, &mut vec![], 6);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::trsm('l', 'x', 'n', 'u', 3, 5, 0.25, &a, 6, &mut vec![], 6);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::trsm('l', 'u', 'x', 'u', 3, 5, 0.25, &a, 6, &mut vec![], 6);
    });
    assert!(result.is_err());
    let result = std::panic::catch_unwind(|| {
        level3::trsm('l', 'u', 'n', 'x', 3, 5, 0.25, &a, 6, &mut vec![], 6);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::trsm('l', 'u', 'n', 'u', 3, 5, 0.25, &a, 2, &mut vec![], 6);
    });
    assert!(result.is_err());

    let result = std::panic::catch_unwind(|| {
        level3::trsm('l', 'u', 'n', 'u', 4, 5, 0.25, &a, 6, &mut vec![], 3);
    });
    assert!(result.is_err());
}
